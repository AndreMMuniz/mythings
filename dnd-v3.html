<div id="quiz-wrapper" style="
  display: flex;
  align-items: flex-start;
  justify-content: center; /* ⬅️ centraliza horizontalmente */
  align-items: stretch;
  gap: 24px;
  flex-wrap: nowrap;
  width: 100%;
  max-width: 1000px; /* opcional: para evitar largura demais */
  margin: 0 auto;     /* centraliza no body */
">

  <!-- Coluna de áudios -->
  <div id="audio-column" style="
    display: flex;
    flex-direction: column;
    gap: 20px;
    padding: 1rem;
    border: 1px solid #ccc;
    border-radius: 10px;
    min-width: 216px;
    background-color: #fafafa;
    flex: 0 0 200px;
    min-height: 100%;
    box-sizing: border-box;
  ">
    <!-- JS insere aqui -->
  </div>

  <!-- Coluna de slots + textos -->
  <div id="text-column-wrapper" style="
    display: flex;
    flex-direction: column;
    gap: 16px;
    padding: 1rem;
    border: 1px solid #ccc;
    border-radius: 10px;
    background-color: #fff;
    width: fit-content;
    max-width: 100%;
    box-sizing: border-box;
  ">
    <div id="text-column" style="display: flex; flex-direction: column; gap: 16px;">
      <!-- JS insere aqui -->
    </div>
  </div>
</div>

<div style="margin-top: 2em; text-align: center;">
  <button id="send-button" onclick="checkAnswers()" style="display: none;">✅ Enviar respostas</button>
  <p id="feedback" style="margin-top: 1em; font-weight: bold;"></p>
</div>

<style>
  .audio-block {
    width: 180px;
    height: 56px;
    border-radius: 10px;
    border: solid 2px rgba(0,0,0,0);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: grab;
    font-size: 24px;
    user-select: none;
    color: white;
    padding: 0.5rem;
    box-sizing: border-box;
  }

  .audio-block button {
    font-size: 28px;
    background: none;
    border: none;
    cursor: pointer;
    color: white;
  }

  .target-slot {
    width: 180px;
    height: 60px;
    border: 2px dashed #ccc;
    border-radius: 12px;
    background-color: white;
    transition: background 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    box-sizing: border-box;
    flex-shrink: 0;
    transition: border 0.3s ease;
  }

  .target-slot.filled {
    background-color: #eef;
    border: 2px solid #888;
  }

  .target-slot.wrong {
    border: 2px solid red !important;
  }
  .target-slot.correct {
    border: 2px solid green !important;
  }

  .quiz-row {
    display: flex;
    align-items: center;
    gap: 1rem;
    height: 60px;
    white-space: nowrap;
  }

  .quiz-text {
    font-size: 1.1rem;
  }
</style>

<script>
/* ======= Proteções contra loop/reentrância ======= */
window.__quiz_initialized = false;
window.__quiz_building = false;
let observer; // será criado depois

function initQuiz() {
  if (window.__quiz_initialized || window.__quiz_building) return;
  window.__quiz_building = true;

  const rawItems = [...document.querySelectorAll('.quiz-item')];
  if (rawItems.length < 3) { window.__quiz_building = false; return; }

  // Lista de cores permitidas
  const allowedColors = [
    "#043372", "#0095e8", "#f4bc12", "#411596",
    "#5360EA", "#FF3737", "#007bbc", "#333333"
  ];

  // Embaralha as cores para distribuição justa
  let shuffledColors = [...allowedColors].sort(() => Math.random() - 0.5);
  let colorIndex = 0;

  const items = rawItems.map(el => {
    if (colorIndex >= shuffledColors.length) {
      shuffledColors = [...allowedColors].sort(() => Math.random() - 0.5);
      colorIndex = 0;
    }
    return {
      id: el.dataset.id,
      text: el.dataset.text,
      audio: el.dataset.audio,
      color: shuffledColors[colorIndex++]
    };
  });

  const allReady = items.every(item => item.id && item.text && item.audio);
  if (!allReady) { window.__quiz_building = false; return; }

  const audioColumn = document.getElementById('audio-column');
  const textColumn = document.getElementById('text-column');
  if (!audioColumn || !textColumn) { window.__quiz_building = false; return; }

  // Limpa colunas
  audioColumn.innerHTML = '';
  textColumn.innerHTML = '';

  // Embaralha listas
  const shuffledAudio = [...items].sort(() => Math.random() - 0.5);
  const shuffledTargets = [...items].sort(() => Math.random() - 0.5);

  // Monta blocos de áudio
  shuffledAudio.forEach(item => {
    const div = document.createElement('div');
    div.className = 'audio-block';
    div.style.backgroundColor = item.color;
    div.setAttribute('draggable', true);
    div.setAttribute('data-id', item.id);
    div.innerHTML = `<button onclick="event.stopPropagation(); new Audio('${item.audio}').play()">🔊</button>`;
    div.addEventListener('dragstart', e => {
      e.dataTransfer.setData('text/plain', item.id);
    });
    audioColumn.appendChild(div);
  });

  // Monta alvos/textos
  shuffledTargets.forEach(item => {
    const row = document.createElement('div');
    row.style.display = 'flex';
    row.style.alignItems = 'center';
    row.style.gap = '12px';

    const textLabel = document.createElement('div');
    textLabel.textContent = item.text;
    textLabel.style.minWidth = '240px';

    const slot = document.createElement('div');
    slot.className = 'target-slot';
    slot.setAttribute('data-correct-id', item.id);
    slot.setAttribute('data-text', item.text);

    slot.ondragover = e => e.preventDefault();
    slot.ondrop = e => {
      e.preventDefault();
      const droppedId = e.dataTransfer.getData('text/plain');
      const dragged = document.querySelector(`.audio-block[data-id="${droppedId}"]`);
      if (!dragged || slot.querySelector('.audio-block')) return;

      // Remove dos outros slots se já estiver
      document.querySelectorAll('.target-slot').forEach(other => {
        if (other !== slot && other.querySelector(`[data-id="${droppedId}"]`)) {
          other.innerHTML = '';
          other.classList.remove('filled', 'wrong');
        }
      });

      slot.innerHTML = '';
      slot.appendChild(dragged);
      slot.classList.add('filled');

      // Mostra botão enviar ao menos 1 drop
      const btn = document.getElementById('send-button');
      if (btn) btn.style.display = 'inline-block';
    };

    row.appendChild(slot);
    row.appendChild(textLabel);
    textColumn.appendChild(row);
  });

  // Marca como montado e desconecta o observer para evitar loops
  window.__quiz_initialized = true;
  window.__quiz_building = false;
  if (observer) observer.disconnect();
}

function checkAnswers() {
  const slots = document.querySelectorAll('.target-slot');
  let correct = 0;

  slots.forEach(slot => {
    const expectedId = slot.getAttribute('data-correct-id');
    const dropped = slot.querySelector('.audio-block');
    slot.classList.remove('wrong', 'correct');

    if (dropped) {
      if (dropped.getAttribute('data-id') === expectedId) {
        correct++;
        slot.classList.add('correct');
      } else {
        slot.classList.add('wrong');
      }
    }
  });

  const total = slots.length;
  const feedback = document.getElementById('feedback');
  feedback.innerText = `✅ Você acertou ${correct} de ${total} perguntas.`;
  feedback.style.color = correct === total ? 'green' : 'darkorange';
}

/* ======= Observer filtrado: só reage quando .quiz-item aparece ======= */
observer = new MutationObserver((mutationList) => {
  if (window.__quiz_initialized || window.__quiz_building) return;

  const hasQuizItemsAdded = mutationList.some(m =>
    Array.from(m.addedNodes || []).some(n =>
      n.nodeType === 1 && (n.matches?.('.quiz-item') || n.querySelector?.('.quiz-item'))
    )
  );

  if (hasQuizItemsAdded) {
    initQuiz();
  }
});

// Observa o body, mas só reagimos quando .quiz-item entra no DOM
observer.observe(document.body, { childList: true, subtree: true });

// Chamada de segurança após o DOM carregar (caso os itens já estejam prontos)
document.addEventListener('DOMContentLoaded', () => {
  setTimeout(() => {
    if (!window.__quiz_initialized) initQuiz();
  }, 80);
});
</script>
