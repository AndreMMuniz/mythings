<div id="quiz-wrapper" style="
  display: flex;
  align-items: flex-start;
  justify-content: center;
  align-items: stretch;
  gap: 24px;
  flex-wrap: nowrap;
  width: 100%;
  max-width: 1000px;
  margin: 0 auto;
">
  <!-- Coluna de áudios -->
  <div id="audio-column" style="
    display: flex;
    flex-direction: column;
    gap: 20px;
    padding: 1rem;
    border: 1px solid #ccc;
    border-radius: 10px;
    min-width: 216px;
    background-color: #fafafa;
    flex: 0 0 200px;
    min-height: 100%;
    box-sizing: border-box;
  "></div>

  <!-- Coluna de slots + textos -->
  <div id="text-column-wrapper" style="
    display: flex;
    flex-direction: column;
    gap: 16px;
    padding: 1rem;
    border: 1px solid #ccc;
    border-radius: 10px;
    background-color: #fff;
    width: fit-content;
    max-width: 100%;
    box-sizing: border-box;
  ">
    <div id="text-column" style="display: flex; flex-direction: column; gap: 16px;"></div>
  </div>
</div>

<div style="margin-top: 2em; text-align: center;">
  <button id="send-button" onclick="checkAnswers()" style="display:none;">✅ Enviar respostas</button>
  <p id="feedback" style="margin-top: 1em; font-weight: bold;"></p>
</div>

<style>
  .audio-block {
    width: 180px; height: 56px; border-radius: 10px;
    border: solid 2px transparent; display:flex; align-items:center; justify-content:center;
    cursor: grab; font-size: 24px; user-select: none; color: white; padding: .5rem; box-sizing: border-box;
  }
  .audio-block button { font-size: 28px; background: none; border: none; cursor: pointer; color: white; }
  .target-slot {
    width: 180px; height: 60px; border: 2px dashed #ccc; border-radius: 12px; background: #fff;
    transition: background .2s, border .3s ease; display:flex; align-items:center; justify-content:center; box-sizing:border-box; flex-shrink:0;
  }
  .target-slot.filled { background-color: #eef; border: 2px solid #888; }
  .target-slot.wrong { border: 2px solid red !important; }
  .target-slot.correct { border: 2px solid green !important; }
  .quiz-row { display:flex; align-items:center; gap:1rem; height:60px; white-space:nowrap; }
  .quiz-text { font-size: 1.1rem; }
</style>

<script>
/* ================== Estado e utilitários ================== */
let __building = false;
let __signature = "";     // Assinatura do conjunto atual de quiz-items
let __debounce = null;    // Debounce para mutações do RG

function makeSignature() {
  const els = Array.from(document.querySelectorAll('.quiz-item'));
  if (!els.length) return "";
  // Usa dados estáveis para detectar mudança de página/conjunto
  return els.map(el => `${el.dataset.id}::${el.dataset.text}::${el.dataset.audio}`).join('||');
}

/* ================== Montagem do quiz ================== */
function initQuiz() {
  if (__building) return;
  __building = true;

  const rawItems = Array.from(document.querySelectorAll('.quiz-item'));
  if (rawItems.length < 1) { __building = false; return; }

  const allowedColors = ["#043372","#0095e8","#f4bc12","#411596","#5360EA","#FF3737","#007bbc","#333333"];
  let shuffledColors = [...allowedColors].sort(() => Math.random() - 0.5);
  let colorIndex = 0;

  const items = rawItems.map(el => {
    if (colorIndex >= shuffledColors.length) {
      shuffledColors = [...allowedColors].sort(() => Math.random() - 0.5);
      colorIndex = 0;
    }
    return {
      id: el.dataset.id, text: el.dataset.text, audio: el.dataset.audio, color: shuffledColors[colorIndex++]
    };
  });

  const allReady = items.every(i => i.id && i.text && i.audio);
  if (!allReady) { __building = false; return; }

  const audioColumn = document.getElementById('audio-column');
  const textColumn  = document.getElementById('text-column');
  if (!audioColumn || !textColumn) { __building = false; return; }

  audioColumn.innerHTML = '';
  textColumn.innerHTML  = '';

  const shuffledAudio   = [...items].sort(() => Math.random() - 0.5);
  const shuffledTargets = [...items].sort(() => Math.random() - 0.5);

  // Áudios
  shuffledAudio.forEach(item => {
    const div = document.createElement('div');
    div.className = 'audio-block';
    div.style.backgroundColor = item.color;
    div.draggable = true;
    div.dataset.id = item.id;
    div.innerHTML = `<button onclick="event.stopPropagation(); new Audio('${item.audio}').play()">🔊</button>`;
    div.addEventListener('dragstart', e => e.dataTransfer.setData('text/plain', item.id));
    audioColumn.appendChild(div);
  });

  // Alvos + textos
  shuffledTargets.forEach(item => {
    const row = document.createElement('div'); row.className = 'quiz-row';

    const slot = document.createElement('div');
    slot.className = 'target-slot';
    slot.dataset.correctId = item.id;
    slot.dataset.text = item.text;

    slot.ondragover = e => e.preventDefault();
    slot.ondrop = e => {
      e.preventDefault();
      const droppedId = e.dataTransfer.getData('text/plain');
      const dragged = document.querySelector(`.audio-block[data-id="${droppedId}"]`);
      if (!dragged || slot.querySelector('.audio-block')) return;

      document.querySelectorAll('.target-slot').forEach(other => {
        if (other !== slot && other.querySelector(`[data-id="${droppedId}"]`)) {
          other.innerHTML = ''; other.classList.remove('filled','wrong','correct');
        }
      });

      slot.innerHTML = '';
      slot.appendChild(dragged);
      slot.classList.add('filled');
      const btn = document.getElementById('send-button');
      if (btn) btn.style.display = 'inline-block';
    };

    const textLabel = document.createElement('div');
    textLabel.textContent = item.text;
    textLabel.style.minWidth = '240px';

    row.appendChild(slot);
    row.appendChild(textLabel);
    textColumn.appendChild(row);
  });

  __building = false;
  // Atualiza assinatura após montar
  __signature = makeSignature();
  // console.log('✅ Quiz montado. assinatura =', __signature);
}

function checkAnswers() {
  const slots = document.querySelectorAll('.target-slot');
  let correct = 0;
  slots.forEach(slot => {
    const expectedId = slot.dataset.correctId;
    const dropped = slot.querySelector('.audio-block');
    slot.classList.remove('wrong','correct');
    if (dropped) {
      if (dropped.dataset.id === expectedId) { correct++; slot.classList.add('correct'); }
      else { slot.classList.add('wrong'); }
    }
  });
  const feedback = document.getElementById('feedback');
  feedback.innerText = `✅ Você acertou ${correct} de ${slots.length} perguntas.`;
  feedback.style.color = correct === slots.length ? 'green' : 'darkorange';
}

/* ================== Auto-refresh por paginação ================== */
/* Observa o documento, mas só reage quando o conjunto de .quiz-item muda */
const rgObserver = new MutationObserver(() => {
  if (__debounce) clearTimeout(__debounce);
  __debounce = setTimeout(() => {
    const sig = makeSignature();
    if (sig && sig !== __signature) {
      // console.log('🔁 Mudou o conjunto de quiz-item. Recarregando...', sig);
      initQuiz();
    }
  }, 80);
});
rgObserver.observe(document.body, { childList: true, subtree: true });

/* ================== Gatilho manual (opcional) ================== */
/* Se quiser chamar no workflow do botão Next: Plugins → Run JavaScript → reloadQuiz(); */
window.reloadQuiz = function() {
  __signature = ""; // força reconstrução
  initQuiz();
};

/* ================== Primeira montagem segura ================== */
document.addEventListener('DOMContentLoaded', () => {
  setTimeout(() => initQuiz(), 80);
});
</script>