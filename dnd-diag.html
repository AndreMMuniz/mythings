<div id="quiz-wrapper" data-exercise-id="[Parent group's Dnd Exercise's unique id]" style="
  display:flex; align-items:flex-start; justify-content:center; align-items:stretch;
  gap:24px; flex-wrap:nowrap; width:100%; max-width:1000px; margin:0 auto;
">
  <div id="audio-column" style="display:flex; flex-direction:column; gap:20px; padding:1rem; border:1px solid #ccc; border-radius:10px; min-width:216px; background-color:#fafafa; flex:0 0 200px; min-height:100%; box-sizing:border-box;"></div>
  <div id="text-column-wrapper" style="display:flex; flex-direction:column; gap:16px; padding:1rem; border:1px solid #ccc; border-radius:10px; background-color:#fff; width:fit-content; max-width:100%; box-sizing:border-box;">
    <div id="text-column" style="display:flex; flex-direction:column; gap:16px;"></div>
  </div>
</div>

<div style="margin-top:2em; text-align:center;">
  <p id="feedback" style="margin-top:1em; font-weight:bold;"></p>
</div>

<style>
  .audio-block { width:180px; height:56px; border-radius:10px; border:solid 2px transparent; display:flex; align-items:center; justify-content:center; cursor:grab; font-size:24px; user-select:none; color:white; padding:.5rem; box-sizing:border-box; }
  .audio-block button { font-size:28px; background:none; border:none; cursor:pointer; color:white; }
  .target-slot { width:180px; height:60px; border:2px dashed #ccc; border-radius:12px; background:#fff; transition:background .2s, border .3s ease; display:flex; align-items:center; justify-content:center; box-sizing:border-box; flex-shrink:0; }
  .target-slot.filled { background-color:#eef; border: 2px solid #888; }
  .target-slot.wrong  { border:2px solid red !important; }
  .target-slot.correct{ border:2px solid green !important; }
  .quiz-row { display:flex; align-items:center; gap:1rem; height:60px; white-space:nowrap; }
</style>

<script>
(function(){
  window.DNDQUIZ = window.DNDQUIZ || {};
  const Q = window.DNDQUIZ;
  Q.mem = Q.mem || {};
  Q._debounce = null;
  Q._building = false;
  Q._observer = Q._observer || null;

  const WRAP = document.getElementById('quiz-wrapper');
  const audioCol = document.getElementById('audio-column');
  const textCol  = document.getElementById('text-column');
  const COLORS = ["#043372","#0095e8","#f4bc12","#411596","#5360EA","#FF3737","#007bbc","#333333"];

  function shuffle(arr){ return [...arr].sort(() => Math.random() - 0.5); }
  function getExerciseId() {
  // 1) tenta do wrapper
  let id = (WRAP?.dataset?.exerciseId || "").trim();

  // Se o wrapper trouxe um literal com colchetes (não resolvido), ignore
  if (id.includes('[') || id.includes(']')) id = "";

  if (id) return id;

  // 2) tenta do primeiro .quiz-item (Bubble resolve aqui)
  const first = document.querySelector('.quiz-item');
  if (first && first.dataset.exercise) return first.dataset.exercise.trim();

  // 3) fallback: vazio (vamos operar sem filtro)
  return "";
}
  function getStateNode(){ return document.getElementById('dnd-state-source'); }
  function readDBStateJSON(){ const n = getStateNode(); if (!n) return ""; return (n.textContent || n.innerText || "").trim(); }

  function getSourceItems(exerciseId) {
    let els;
    if (exerciseId) { els = Array.from(document.querySelectorAll(`.quiz-item[data-exercise="${exerciseId}"]`)); if (!els.length) els = Array.from(document.querySelectorAll('.quiz-item')); }
    else { els = Array.from(document.querySelectorAll('.quiz-item')); }
    return els.map(el => ({ id:(el.dataset.id||"").trim(), text:(el.dataset.text||"").trim(), audio:(el.dataset.audio||"").trim() })).filter(i => i.id && i.text && i.audio);
  }

  function makeSignature(items){ const sorted=[...items].sort((a,b)=>a.id>b.id?1:-1); return sorted.map(i=>`${i.id}|${i.text}|${i.audio}`).join('||'); }

  function ensureLayoutState(exId, items){
    const sig = makeSignature(items); const entry = Q.mem[exId] || {};
    if (entry.signature !== sig) {
      const ids = items.map(i=>i.id);
      const audioOrder  = shuffle(ids);
      const targetOrder = shuffle(ids);
      const colorMap = {}; audioOrder.forEach((aid, idx) => colorMap[aid] = COLORS[idx % COLORS.length]);
      Q.mem[exId] = { signature:sig, audioOrder, targetOrder, colorMap, pairs:[] };
    }
    return Q.mem[exId];
  }

function tryLoadPairsFromDB(){
  const raw = readDBStateJSON();
  if (!raw) return null;

  // Caso 1: JSON normal → parse direto
  try {
    const obj = JSON.parse(raw);
    if (Array.isArray(obj)) return obj;
    if (obj && Array.isArray(obj.pairs)) return obj.pairs;
  } catch(e){}

  // Caso 2: JSON "duplamente codificado" (com \" ... \")
  // Ex.: "\"{\\\"pairs\\\":[...] }\"" ou "{\"pairs\":[...]}"
  try {
    const once = JSON.parse(raw);     // remove as barras invertidas
    const obj2 = typeof once === 'string' ? JSON.parse(once) : once;
    if (Array.isArray(obj2)) return obj2;
    if (obj2 && Array.isArray(obj2.pairs)) return obj2.pairs;
  } catch(e){}

  return null;
}
  function rememberPairs(exId){
    const pairs = Array.from(document.querySelectorAll('.target-slot')).map(slot => {
      const slotId = slot.dataset.correctId; const dropped = slot.querySelector('.audio-block');
      return { slotId, audioId: dropped ? dropped.dataset.id : null };
    });
    if (!Q.mem[exId]) Q.mem[exId] = {}; Q.mem[exId].pairs = pairs;
    try { if (typeof window.bubble_fn_dnd_state === 'function') { window.bubble_fn_dnd_state(JSON.stringify({ exerciseId:exId, pairs })); } } catch(e){}
  }

  function restorePairs(exId){
    const entry = Q.mem[exId] || {};
    let pairs = entry.pairs;
    if (!pairs || !pairs.length) { const fromDB = tryLoadPairsFromDB(); if (fromDB && fromDB.length) { pairs = fromDB; entry.pairs = fromDB; Q.mem[exId] = entry; } }
    if (!pairs || !pairs.length) return;

    const audioMap = {}; document.querySelectorAll('.audio-block').forEach(div => audioMap[div.dataset.id] = div);

    pairs.forEach(({slotId, audioId}) => {
      const slot = document.querySelector(`.target-slot[data-correct-id="${slotId}"]`); if (!slot) return;
      slot.innerHTML = ''; slot.classList.remove('filled','wrong','correct');
      if (audioId && audioMap[audioId]) {
        document.querySelectorAll('.target-slot').forEach(other => { if (other !== slot && other.querySelector(`[data-id="${audioId}"]`)) { other.innerHTML = ''; other.classList.remove('filled','wrong','correct'); } });
        slot.appendChild(audioMap[audioId]); slot.classList.add('filled');
      }
    });
  }

  function buildUI(){
    if (Q._building) return; Q._building = true;
    try {
      if (!audioCol || !textCol) return;
      const EXERCISE_ID = getExerciseId();
      const items = getSourceItems(EXERCISE_ID); if (!items.length) return;
      const entry = ensureLayoutState(EXERCISE_ID, items);
      audioCol.innerHTML=''; textCol.innerHTML='';

      entry.audioOrder.forEach(aid => {
        const item = items.find(it => it.id === aid); if (!item) return;
        const div = document.createElement('div'); div.className='audio-block'; div.style.backgroundColor = entry.colorMap[aid] || COLORS[0];
        div.draggable = true; div.dataset.id = item.id;
        div.innerHTML = `<button onclick="event.stopPropagation(); new Audio('${item.audio}').play()">🔊</button>`;
        div.addEventListener('dragstart', e => e.dataTransfer.setData('text/plain', item.id));
        audioCol.appendChild(div);
      });

      entry.targetOrder.forEach(tid => {
        const item = items.find(it => it.id === tid); if (!item) return;
        const row = document.createElement('div'); row.className = 'quiz-row';
        const slot = document.createElement('div'); slot.className='target-slot'; slot.dataset.correctId=item.id; slot.dataset.text=item.text;
        slot.ondragover = e => e.preventDefault();
        slot.ondrop = e => {
          e.preventDefault();
          const droppedId = e.dataTransfer.getData('text/plain');
          const dragged = document.querySelector(`.audio-block[data-id="${droppedId}"]`);
          if (!dragged || slot.querySelector('.audio-block')) return;
          document.querySelectorAll('.target-slot').forEach(other => { if (other !== slot && other.querySelector(`[data-id="${droppedId}"]`)) { other.innerHTML=''; other.classList.remove('filled','wrong','correct'); } });
          slot.innerHTML=''; slot.appendChild(dragged); slot.classList.add('filled');
          rememberPairs(EXERCISE_ID);
        };
        const label = document.createElement('div'); label.textContent=item.text; label.style.minWidth='240px';
        row.appendChild(slot); row.appendChild(label); textCol.appendChild(row);
      });

      restorePairs(EXERCISE_ID);
    } finally { setTimeout(() => { Q._building = false; }, 0); }
  }

  function checkAnswers(){
    const slots=document.querySelectorAll('.target-slot'); let correct=0;
    slots.forEach(slot => { const expectedId=slot.dataset.correctId; const dropped=slot.querySelector('.audio-block'); slot.classList.remove('wrong','correct');
      if (dropped) { if (dropped.dataset.id === expectedId) { correct++; slot.classList.add('correct'); } else { slot.classList.add('wrong'); } }
    });
    const total=slots.length; const isCorrect=(total>0 && correct===total);
    const fb=document.getElementById('feedback'); if (fb) { fb.innerText=isCorrect?`🎉 Tudo correto (${correct}/${total}).`:`⚠️ Existem erros (${correct}/${total}).`; fb.style.color=isCorrect?'green':'darkorange'; }
    try { if (typeof window.bubble_fn_dnd_is_correct === 'function') { window.bubble_fn_dnd_is_correct(isCorrect); } } catch(e){}
    return isCorrect;
  }

  window.reloadQuiz   = function(){ const fb=document.getElementById('feedback'); if (fb) fb.textContent=''; buildUI(); };
  window.checkAnswers = function(){ return checkAnswers(); };

  if (Q._observer) { try { Q._observer.disconnect(); } catch(e){} }
  Q._observer = new MutationObserver(() => { if (Q._building) return; clearTimeout(Q._debounce); Q._debounce = setTimeout(buildUI, 200); });
  Q._observer.observe(document.body, { childList:true, subtree:true });

  document.addEventListener('DOMContentLoaded', () => setTimeout(buildUI, 150));
})();
</script>
